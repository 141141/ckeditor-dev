<textarea id="editor">
<p>
	<a href="http://cksource.com">
		<img alt="foo" src="../../image2/_assets/foo.png" />
	</a>
	<br>
	<img alt="foo" src="../../image2/_assets/bar.png" />
	<figure class="image" style="float:left">
		<a href="http://cksource.com">
			<img alt="foo" src="../../image2/_assets/foo.png" />
		</a>
		<figcaption>Caption</figcaption></figure>
	<figure class="image" style="float:right">
		<img alt="foo" src="../../image2/_assets/bar.png" />
		<figcaption>Caption</figcaption>
	</figure>
</p>
</textarea>
<div id="test_border_buttons">
	<p>Test inline styles with:</p>
</div>

<div id="test_font_buttons">
	<p>Test class styles with:</p>
</div>

<textarea name="output" id="output" cols="40" rows="25" readonly="readonly"></textarea>
<script>
	CKEDITOR.addCss(
		'.font_big { font-size: 24px }' +
		'.font_italic { font-style: italic }'
	);

	var writeOutput = widgetTestsTools.writeOutput;

	editor = CKEDITOR.replace( 'editor', {
		allowedContent: true,
		height: 500,
		on: {
			pluginsLoaded: function( evt ) {
				var editor = evt.editor,
					borderStyles = {
						name: 'Border',
						style: {
							add: createStyle( { styles: { 'border': 'solid 1px black' } } ),
							thin: createStyle( { styles: { 'border-width': '1px' } } ),
							fat: createStyle( { styles: { 'border-width': '5px' } } ),
							solid: createStyle( { styles: { 'border-style': 'solid' } } ),
							dotted: createStyle( { styles: { 'border-style': 'dotted' } } )
						}
					},
					fontStyles = {
						name: 'Font',
						style: {
							big: createStyle( { attributes: { 'class': 'font_big' } } ),
							italic: createStyle( { attributes: { 'class': 'font_italic' } } )
						}
					};

				addCommandsAndButtons( borderStyles, '#test_border_buttons' );
				addCommandsAndButtons( fontStyles, '#test_font_buttons' );

				function createStyle( config ) {
					return new CKEDITOR.style( {
						type: 'widget',
						widget: 'image',
						styles: config.styles,
						attributes: config.attributes
					} );
				}

				function addCommandsAndButtons( styleObj, appendTo ) {
					var key, button, removeButton;

					for ( key in styleObj.style ) {
						button = new CKEDITOR.dom.element( 'button' );
						button.setText( styleObj.name + ' ' + key );

						// No let variable in ES5 so I need to create separate scope for listeners :'(
						( function() {
							var command = styleObj.name + key,
								thisKey = key;

							editor.addCommand( command, {
								exec: function() {
									editor.applyStyle( styleObj.style[ thisKey ] );
								}
							} );

							button.on( 'click', function() {
								editor.execCommand( command );
							} );

							CKEDITOR.document.findOne( appendTo ).append( button );

							if ( styleObj.name === 'Font' ) {
								removeButton = new CKEDITOR.dom.element( 'button' );
								removeButton.setText( 'Remove font ' + key );

								editor.addCommand( 'remove' + command, {
									exec: function() {
										editor.removeStyle( styleObj.style[ thisKey ] );
									}
								} );

								removeButton.on( 'click', function() {
									editor.execCommand( 'remove' + command );
								} );

								CKEDITOR.document.findOne( appendTo ).append( removeButton );
							}
						} )();
					}
					if ( styleObj.name === 'Border' ) {
						removeButton = new CKEDITOR.dom.element( 'button' );
						removeButton.setText( 'Remove border' );

						editor.addCommand( 'removeborder', {
							exec: function() {
								editor.removeStyle( createStyle( {
									styles: {
										'border': '',
										'border-width': '',
										'border-style': ''
									}
								} ) );
							}
						} );
						removeButton.on( 'click', function() {
							editor.execCommand( 'removeborder' )
						} );
						CKEDITOR.document.findOne( appendTo ).append( removeButton );
					}
				}
			},
			instanceReady: function() {
				var output = CKEDITOR.document.getById( 'output' ),
					widgets = this.widgets,
					previousWidget;

				this.on( 'selectionChange', function() {
					if ( previousWidget = widgets.focused ) {
						writeOutput( widgets.focused, output );
					}
				} );

				setInterval( function(){
					if ( previousWidget && ( previousWidget.id in widgets.instances ) ) {
						writeOutput( previousWidget, output)
					} else {
						for ( var i = 0; i < widgets._.nextId; i++ ) {
							if ( previousWidget = widgets.instances[ i ] ) {
								break;
							}
						}
					}
				}, 100 );
			}
		}
	}, 1 );

</script>
